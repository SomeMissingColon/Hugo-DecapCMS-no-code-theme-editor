{{/* Google Analytics 4 (GA4) Implementation */}}
{{ if and .Site.Data.theme.analytics.enabled .Site.Data.theme.analytics.ga4_id }}
{{ $ga4_id := .Site.Data.theme.analytics.ga4_id }}
{{ $cookie_consent := .Site.Data.theme.analytics.cookie_consent | default true }}
{{ $track_external := .Site.Data.theme.analytics.track_external_links | default true }}
{{ $track_downloads := .Site.Data.theme.analytics.track_downloads | default true }}
{{ $enhanced_ecommerce := .Site.Data.theme.analytics.enhanced_ecommerce | default false }}
{{ $debug_mode := .Site.Data.theme.analytics.debug_mode | default false }}

{{/* Google Analytics Global Site Tag (gtag.js) */}}
<script async src="https://www.googletagmanager.com/gtag/js?id={{ $ga4_id }}"></script>
<script>
  // Initialize Google Analytics
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  
  {{ if $cookie_consent }}
  // GDPR Cookie Consent - Only initialize after consent
  if (localStorage.getItem('analytics-consent') === 'granted' || 
      sessionStorage.getItem('analytics-consent') === 'granted') {
    initializeAnalytics();
  }
  
  function initializeAnalytics() {
  {{ end }}
    gtag('js', new Date());
    
    // Configure GA4
    gtag('config', '{{ $ga4_id }}', {
      {{ if $debug_mode }}
      'debug_mode': true,
      {{ end }}
      'anonymize_ip': true,
      'respect_dnt': true,
      {{ if $enhanced_ecommerce }}
      'send_page_view': false, // We'll send custom page views with ecommerce data
      {{ end }}
      'cookie_flags': 'SameSite=Strict;Secure'
    });

    {{ if $enhanced_ecommerce }}
    // Enhanced Ecommerce Configuration
    gtag('config', '{{ $ga4_id }}', {
      'custom_map': {
        'custom_parameter_1': 'page_category',
        'custom_parameter_2': 'user_type'
      }
    });
    {{ end }}

    // Track page views (enhanced ecommerce sends custom events)
    {{ if not $enhanced_ecommerce }}
    gtag('event', 'page_view', {
      'page_title': document.title,
      'page_location': window.location.href,
      'content_group1': '{{ .Section | default "home" }}',
      'content_group2': '{{ .Type | default "page" }}'
    });
    {{ end }}

    {{ if $track_external }}
    // Track External Link Clicks
    document.addEventListener('click', function(event) {
      const link = event.target.closest('a');
      if (link && link.hostname && link.hostname !== window.location.hostname) {
        gtag('event', 'click', {
          'event_category': 'external_link',
          'event_label': link.href,
          'transport_type': 'beacon'
        });
      }
    });
    {{ end }}

    {{ if $track_downloads }}
    // Track File Downloads
    document.addEventListener('click', function(event) {
      const link = event.target.closest('a');
      if (link && link.href) {
        const fileExtension = link.pathname.split('.').pop().toLowerCase();
        const downloadableFiles = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'zip', 'rar', '7z', 'tar', 'gz'];
        
        if (downloadableFiles.includes(fileExtension)) {
          gtag('event', 'file_download', {
            'event_category': 'download',
            'event_label': link.href,
            'file_extension': fileExtension,
            'file_name': link.pathname.split('/').pop(),
            'transport_type': 'beacon'
          });
        }
      }
    });
    {{ end }}

    // Track Form Submissions
    document.addEventListener('submit', function(event) {
      const form = event.target;
      if (form.tagName === 'FORM') {
        gtag('event', 'form_submit', {
          'event_category': 'form',
          'event_label': form.action || window.location.href,
          'form_id': form.id || 'unnamed_form',
          'transport_type': 'beacon'
        });
      }
    });

    // Track Scroll Depth
    let scrollDepthMarkers = [25, 50, 75, 90];
    let scrollDepthTriggered = [];
    
    window.addEventListener('scroll', function() {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const docHeight = Math.max(
        document.body.scrollHeight,
        document.body.offsetHeight,
        document.documentElement.clientHeight,
        document.documentElement.scrollHeight,
        document.documentElement.offsetHeight
      );
      const winHeight = window.innerHeight;
      const scrollPercent = Math.round((scrollTop / (docHeight - winHeight)) * 100);
      
      scrollDepthMarkers.forEach(function(marker) {
        if (scrollPercent >= marker && !scrollDepthTriggered.includes(marker)) {
          scrollDepthTriggered.push(marker);
          gtag('event', 'scroll', {
            'event_category': 'engagement',
            'event_label': marker + '%',
            'value': marker,
            'transport_type': 'beacon'
          });
        }
      });
    });

  {{ if $cookie_consent }}
  }
  
  // Cookie Consent Management
  window.grantAnalyticsConsent = function() {
    localStorage.setItem('analytics-consent', 'granted');
    initializeAnalytics();
  };
  
  window.revokeAnalyticsConsent = function() {
    localStorage.removeItem('analytics-consent');
    sessionStorage.removeItem('analytics-consent');
    // Clear GA cookies
    document.cookie = "_ga=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=." + window.location.hostname;
    document.cookie = "_ga_{{ $ga4_id | replace "G-" "" }}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=." + window.location.hostname;
  };
  {{ end }}

  {{ if $debug_mode }}
  // Debug Mode Console Logging
  console.log('Google Analytics 4 initialized with ID: {{ $ga4_id }}');
  console.log('Cookie Consent: {{ $cookie_consent }}');
  console.log('Track External Links: {{ $track_external }}');
  console.log('Track Downloads: {{ $track_downloads }}');
  console.log('Enhanced Ecommerce: {{ $enhanced_ecommerce }}');
  {{ end }}
</script>

{{ if $cookie_consent }}
{{/* Basic Cookie Consent Banner (can be styled with CSS) */}}
<div id="cookie-consent" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #333; color: white; padding: 1rem; z-index: 9999; text-align: center;">
  <p style="margin: 0 0 1rem 0;">
    This website uses cookies to analyze traffic and improve your experience. 
    <a href="/privacy/" style="color: #fff; text-decoration: underline;">Learn more</a>
  </p>
  <button onclick="acceptCookies()" style="background: #007cba; color: white; border: none; padding: 0.5rem 1rem; margin: 0 0.5rem; border-radius: 4px; cursor: pointer;">
    Accept
  </button>
  <button onclick="declineCookies()" style="background: #666; color: white; border: none; padding: 0.5rem 1rem; margin: 0 0.5rem; border-radius: 4px; cursor: pointer;">
    Decline
  </button>
</div>

<script>
  // Show cookie consent banner if no preference is set
  if (!localStorage.getItem('analytics-consent') && !sessionStorage.getItem('analytics-consent')) {
    document.getElementById('cookie-consent').style.display = 'block';
  }
  
  function acceptCookies() {
    document.getElementById('cookie-consent').style.display = 'none';
    window.grantAnalyticsConsent();
  }
  
  function declineCookies() {
    document.getElementById('cookie-consent').style.display = 'none';
    sessionStorage.setItem('analytics-consent', 'denied');
  }
</script>
{{ end }}

{{ end }}
{{/* End of Analytics Implementation */}}